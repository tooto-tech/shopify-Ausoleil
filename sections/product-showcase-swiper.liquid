{%- comment -%}
  Product Showcase Swiper Section
  - 左右两侧都可以添加自定义块
  - 支持进度条导航
  - 支持自动播放和循环
{%- endcomment -%}

<div class="product-showcase-swiper-section">
  <div class="swiper product-showcase-swiper" id="product-showcase-swiper-{{ section.id }}">
    <div class="swiper-wrapper">
      {% for block in section.blocks %}
        {% if block.type == 'slide' %}
          <div class="swiper-slide product-showcase-slide" {{ block.shopify_attributes }}>
            <div class="product-showcase-slide__container">
              <!-- 左侧区域 -->
              <div class="product-showcase-slide__left">
                {% if block.settings.left_image != blank %}
                  {{
                    block.settings.left_image
                    | image_url: width: 1500
                    | image_tag:
                      loading: 'lazy',
                      class: 'product-showcase-slide__img',
                      alt: block.settings.left_image.alt
                  }}
                {% else %}
                  <div class="product-showcase-slide__placeholder">
                    {{ 'lifestyle-1' | placeholder_svg_tag: 'placeholder-svg' }}
                  </div>
                {% endif %}
              </div>

              <!-- 右侧区域 -->
              <div class="product-showcase-slide__right">
                {% if block.settings.right_image != blank %}
                  {% if block.settings.link != blank %}
                    <a href="{{ block.settings.link }}" class="product-showcase-slide__link">
                  {% endif %}
                  {{
                    block.settings.right_image
                    | image_url: width: 800
                    | image_tag:
                      loading: 'lazy',
                      class: 'product-showcase-slide__product-img',
                      alt: block.settings.right_image.alt
                  }}
                  {% if block.settings.link != blank %}
                    </a>
                  {% endif %}
                {% endif %}

                {% if block.settings.title != blank %}
                  <h3 class="product-showcase-slide__title">
                    {% if block.settings.link != blank %}
                      <a href="{{ block.settings.link }}">{{ block.settings.title }}</a>
                    {% else %}
                      {{ block.settings.title }}
                    {% endif %}
                  </h3>
                {% endif %}

                {% if block.settings.subtitle != blank %}
                  <p class="product-showcase-slide__subtitle">{{ block.settings.subtitle }}</p>
                {% endif %}

                {% if block.settings.product != blank %}
                  {% assign product = block.settings.product %}
                  <div class="product-showcase-slide__price">
                    {% render 'price', product_resource: product, show_unit_price: false %}
                  </div>
                {% endif %}

                {% if block.settings.button_label != blank and block.settings.link != blank %}
                  <a href="{{ block.settings.link }}" class="product-showcase-slide__button">
                    {{ block.settings.button_label }}
                  </a>
                {% endif %}
              </div>
            </div>
          </div>
        {% endif %}
      {% endfor %}
    </div>

    <!-- 进度条 -->
    <div class="product-showcase-swiper__progress">
      <div class="product-showcase-swiper__progress-track">
        <div class="product-showcase-swiper__progress-fill"></div>
      </div>
    </div>
  </div>
</div>

<script>
  (function() {
    'use strict';

    function initSwiper() {
      if (typeof Swiper === 'undefined') {
        setTimeout(initSwiper, 100);
        return;
      }

      const swiperEl = document.querySelector('#product-showcase-swiper-{{ section.id }}');
      if (!swiperEl) return;

      const slides = swiperEl.querySelectorAll('.swiper-slide');
      const slidesCount = slides.length;
      if (slidesCount === 0) return;

      const progressTrack = swiperEl.querySelector('.product-showcase-swiper__progress-track');
      const progressFill = swiperEl.querySelector('.product-showcase-swiper__progress-fill');

      // 进度条配置
      const segmentWidth = window.innerWidth <= 749 ? 35 : 70;
      const totalWidth = slidesCount * segmentWidth;

      if (progressTrack && progressFill) {
        progressTrack.style.width = totalWidth + 'px';
        progressFill.style.width = segmentWidth + 'px';
      }

      // Swiper 配置
      const swiper = new Swiper(swiperEl, {
        slidesPerView: 1,
        spaceBetween: 0,
        loop: {{ section.settings.loop | default: true }},
        speed: {{ section.settings.speed | default: 500 }},
        {% if section.settings.autoplay %}
        autoplay: {
          delay: {{ section.settings.autoplay_delay | default: 3000 }},
          disableOnInteraction: false,
        },
        {% endif %}
      });

      // 更新进度条位置
      function updateProgress() {
        if (!progressFill) return;
        const realIndex = swiper.realIndex || 0;
        progressFill.style.transform = 'translateX(' + (realIndex * segmentWidth) + 'px)';
      }

      // 点击进度条切换
      if (progressTrack) {
        progressTrack.addEventListener('click', function(e) {
          const rect = progressTrack.getBoundingClientRect();
          const clickX = e.clientX - rect.left;
          const targetIndex = Math.floor(clickX / segmentWidth);
          if (targetIndex >= 0 && targetIndex < slidesCount) {
            swiper.slideToLoop(targetIndex);
          }
        });
      }

      updateProgress();
      swiper.on('slideChange', updateProgress);

      // 响应式更新
      window.addEventListener('resize', function() {
        const newSegmentWidth = window.innerWidth <= 749 ? 35 : 70;
        const newTotalWidth = slidesCount * newSegmentWidth;
        if (progressTrack) progressTrack.style.width = newTotalWidth + 'px';
        if (progressFill) progressFill.style.width = newSegmentWidth + 'px';
      });
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initSwiper);
    } else {
      initSwiper();
    }
  })();
</script>

{% stylesheet %}
  .product-showcase-swiper-section {
    width: 100%;
    background-color: #f5f5ef;
  }

  .product-showcase-swiper {
    width: 100%;
    position: relative;
    padding-bottom: 60px;
  }

  .product-showcase-slide__container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    min-height: 500px;
  }

  .product-showcase-slide__left {
    width: 100%;
    height: 100%;
  }

  .product-showcase-slide__left .product-showcase-slide__img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }

  .product-showcase-slide__placeholder {
    width: 100%;
    height: 100%;
    min-height: 400px;
    background: rgba(0, 0, 0, 0.05);
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .product-showcase-slide__placeholder .placeholder-svg {
    width: 50%;
    opacity: 0.3;
  }

  .product-showcase-slide__right {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 40px;
    text-align: center;
  }

  .product-showcase-slide__product-img {
    max-width: 300px;
    width: 100%;
    height: auto;
    margin-bottom: 20px;
  }

  .product-showcase-slide__title {
    font-size: 18px;
    font-weight: 500;
    margin: 0 0 10px;
    color: #000;
  }

  .product-showcase-slide__title a {
    color: inherit;
    text-decoration: none;
  }

  .product-showcase-slide__subtitle {
    font-size: 14px;
    color: #666;
    margin: 0 0 15px;
  }

  .product-showcase-slide__price {
    font-size: 16px;
    margin-bottom: 20px;
  }

  .product-showcase-slide__button {
    display: inline-block;
    padding: 12px 30px;
    background: #000;
    color: #fff;
    text-decoration: none;
    font-size: 14px;
    transition: opacity 0.3s;
  }

  .product-showcase-slide__button:hover {
    opacity: 0.8;
  }

  .product-showcase-slide__link {
    display: block;
  }

  /* 进度条 */
  .product-showcase-swiper__progress {
    position: absolute;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
  }

  .product-showcase-swiper__progress-track {
    height: 2px;
    background: rgba(0, 0, 0, 0.2);
    cursor: pointer;
    position: relative;
  }

  .product-showcase-swiper__progress-fill {
    position: absolute;
    left: 0;
    top: 0;
    height: 100%;
    background: #000;
    transition: transform 0.3s ease;
  }

  /* 移动端 */
  @media (max-width: 749px) {
    .product-showcase-slide__container {
      grid-template-columns: 1fr;
      min-height: auto;
    }

    .product-showcase-slide__left {
      height: 300px;
    }

    .product-showcase-slide__right {
      padding: 30px 20px;
    }

    .product-showcase-slide__product-img {
      max-width: 200px;
    }

    .product-showcase-swiper__progress-track {
      height: 1px;
    }
  }
{% endstylesheet %}

{% schema %}
{
  "name": "Product Showcase Swiper",
  "tag": "section",
  "settings": [
    {
      "type": "checkbox",
      "id": "autoplay",
      "label": "自动播放",
      "default": true
    },
    {
      "type": "range",
      "id": "autoplay_delay",
      "label": "自动播放间隔",
      "min": 2000,
      "max": 9500,
      "step": 500,
      "unit": "ms",
      "default": 4000
    },
    {
      "type": "range",
      "id": "speed",
      "label": "切换速度",
      "min": 300,
      "max": 1000,
      "step": 100,
      "unit": "ms",
      "default": 500
    },
    {
      "type": "checkbox",
      "id": "loop",
      "label": "循环播放",
      "default": true
    }
  ],
  "blocks": [
    {
      "type": "slide",
      "name": "幻灯片",
      "settings": [
        {
          "type": "header",
          "content": "左侧区域"
        },
        {
          "type": "image_picker",
          "id": "left_image",
          "label": "左侧图片"
        },
        {
          "type": "header",
          "content": "右侧区域"
        },
        {
          "type": "image_picker",
          "id": "right_image",
          "label": "右侧图片"
        },
        {
          "type": "text",
          "id": "title",
          "label": "标题"
        },
        {
          "type": "text",
          "id": "subtitle",
          "label": "副标题"
        },
        {
          "type": "product",
          "id": "product",
          "label": "关联产品（用于显示价格）"
        },
        {
          "type": "text",
          "id": "button_label",
          "label": "按钮文字"
        },
        {
          "type": "url",
          "id": "link",
          "label": "链接"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Product Showcase Swiper",
      "blocks": [{ "type": "slide" }, { "type": "slide" }]
    }
  ]
}
{% endschema %}
