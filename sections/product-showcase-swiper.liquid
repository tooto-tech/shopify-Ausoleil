{%- comment -%}
  Product Showcase Swiper
  - 使用 slide_group 作为分隔符来分组
  - left_content 和 right_content blocks 会被分配到对应的 slide
{%- endcomment -%}

<div class="pss-section" style="background-color: {{ section.settings.bg_color }};">
  <div class="swiper pss-swiper" id="pss-{{ section.id }}">
    <div class="swiper-wrapper">
      {%- for block in section.blocks -%}
        {%- if block.type == 'slide' -%}
          <div class="swiper-slide pss-slide" {{ block.shopify_attributes }}>
            <div class="pss-slide__container">
              <!-- 左侧 -->
              <div class="pss-slide__left">
                {%- if block.settings.left_image != blank -%}
                  <img
                    src="{{ block.settings.left_image | image_url: width: 1200 }}"
                    alt="{{ block.settings.left_image.alt | escape }}"
                    class="pss-slide__left-img"
                    loading="lazy"
                    width="{{ block.settings.left_image.width }}"
                    height="{{ block.settings.left_image.height }}"
                  >
                {%- else -%}
                  <div class="pss-slide__placeholder">
                    {{ 'image' | placeholder_svg_tag }}
                  </div>
                {%- endif -%}
              </div>

              <!-- 右侧 -->
              <div class="pss-slide__right">
                {%- if block.settings.see_more_text != blank -%}
                  <a href="{{ block.settings.see_more_link }}" class="pss-slide__see-more">
                    {{ block.settings.see_more_text }}
                  </a>
                {%- endif -%}

                {%- if block.settings.right_image != blank -%}
                  <div class="pss-slide__product-image">
                    {%- if block.settings.product != blank -%}
                      <a href="{{ block.settings.product.url }}">
                    {%- endif -%}
                    <img
                      src="{{ block.settings.right_image | image_url: width: 600 }}"
                      alt="{{ block.settings.right_image.alt | escape }}"
                      class="pss-slide__product-img"
                      loading="lazy"
                      width="{{ block.settings.right_image.width }}"
                      height="{{ block.settings.right_image.height }}"
                    >
                    {%- if block.settings.product != blank -%}
                      </a>
                    {%- endif -%}
                  </div>
                {%- elsif block.settings.product != blank and block.settings.product.featured_image != blank -%}
                  <div class="pss-slide__product-image">
                    <a href="{{ block.settings.product.url }}">
                      <img
                        src="{{ block.settings.product.featured_image | image_url: width: 600 }}"
                        alt="{{ block.settings.product.title | escape }}"
                        class="pss-slide__product-img"
                        loading="lazy"
                        width="{{ block.settings.product.featured_image.width }}"
                        height="{{ block.settings.product.featured_image.height }}"
                      >
                    </a>
                  </div>
                {%- endif -%}

                {%- if block.settings.product != blank -%}
                  <h3 class="pss-slide__title">
                    <a href="{{ block.settings.product.url }}">{{ block.settings.product.title }}</a>
                  </h3>
                  <div class="pss-slide__price">
                    {%- render 'price', product_resource: block.settings.product, show_unit_price: false -%}
                  </div>
                {%- elsif block.settings.custom_title != blank -%}
                  <h3 class="pss-slide__title">{{ block.settings.custom_title }}</h3>
                  {%- if block.settings.custom_price != blank -%}
                    <div class="pss-slide__price">{{ block.settings.custom_price }}</div>
                  {%- endif -%}
                {%- endif -%}
              </div>
            </div>
          </div>
        {%- endif -%}
      {%- endfor -%}
    </div>

    <!-- 进度条 -->
    <div class="pss-progress">
      <div class="pss-progress__track" id="pss-track-{{ section.id }}">
        <div class="pss-progress__fill" id="pss-fill-{{ section.id }}"></div>
      </div>
    </div>
  </div>
</div>

<script>
  (function() {
    function init() {
      if (typeof Swiper === 'undefined') {
        setTimeout(init, 100);
        return;
      }

      var el = document.getElementById('pss-{{ section.id }}');
      if (!el) return;

      var slides = el.querySelectorAll('.swiper-slide');
      var count = slides.length;
      if (count === 0) return;

      var track = document.getElementById('pss-track-{{ section.id }}');
      var fill = document.getElementById('pss-fill-{{ section.id }}');
      var segW = window.innerWidth <= 749 ? 35 : 70;

      if (track) track.style.width = (count * segW) + 'px';
      if (fill) fill.style.width = segW + 'px';

      var swiper = new Swiper(el, {
        slidesPerView: 1,
        spaceBetween: 0,
        speed: {{ section.settings.speed | default: 500 }},
        loop: {% if section.settings.loop %}true{% else %}false{% endif %},
        {% if section.settings.autoplay %}
        autoplay: {
          delay: {{ section.settings.autoplay_delay | default: 4000 }},
          disableOnInteraction: false
        },
        {% endif %}
      });

      function updateProgress() {
        if (!fill) return;
        var idx = swiper.realIndex || 0;
        fill.style.transform = 'translateX(' + (idx * segW) + 'px)';
      }

      updateProgress();
      swiper.on('slideChange', updateProgress);

      if (track) {
        track.addEventListener('click', function(e) {
          var rect = track.getBoundingClientRect();
          var x = e.clientX - rect.left;
          var target = Math.floor(x / segW);
          if (target >= 0 && target < count) {
            swiper.slideToLoop(target);
          }
        });
      }

      window.addEventListener('resize', function() {
        segW = window.innerWidth <= 749 ? 35 : 70;
        if (track) track.style.width = (count * segW) + 'px';
        if (fill) fill.style.width = segW + 'px';
        updateProgress();
      });
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  })();
</script>

<style>
  .pss-section {
    width: 100%;
    padding: 0;
  }
  .pss-swiper {
    width: 100%;
    position: relative;
    overflow: hidden;
  }
  .pss-slide__container {
    display: grid;
    grid-template-columns: 45% 55%;
  }
  .pss-slide__left {
    position: relative;
  }
  .pss-slide__left-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }
  .pss-slide__placeholder {
    width: 100%;
    height: 400px;
    background: rgba(0, 0, 0, 0.05);
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .pss-slide__placeholder svg {
    width: 100px;
    opacity: 0.3;
  }
  .pss-slide__right {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 60px 40px;
    position: relative;
  }
  .pss-slide__see-more {
    position: absolute;
    top: 30px;
    right: 40px;
    font-size: 14px;
    color: #000;
    text-decoration: none;
    font-weight: 500;
  }
  .pss-slide__see-more:hover {
    opacity: 0.7;
  }
  .pss-slide__product-image {
    max-width: 320px;
    margin-bottom: 24px;
  }
  .pss-slide__product-img {
    width: 100%;
    height: auto;
    display: block;
  }
  .pss-slide__title {
    font-size: 16px;
    font-weight: 500;
    margin: 0 0 12px;
    text-align: center;
  }
  .pss-slide__title a {
    color: #000;
    text-decoration: none;
  }
  .pss-slide__price {
    font-size: 16px;
    text-align: center;
    margin-bottom: 20px;
  }
  /* 进度条 */
  .pss-progress {
    display: flex;
    justify-content: center;
    padding: 30px 0;
  }
  .pss-progress__track {
    height: 2px;
    background: rgba(0, 0, 0, 0.2);
    position: relative;
    cursor: pointer;
  }
  .pss-progress__fill {
    position: absolute;
    left: 0;
    top: 0;
    height: 100%;
    background: #000;
    transition: transform 0.3s ease;
  }
  /* 移动端 */
  @media (max-width: 749px) {
    .pss-slide__container {
      grid-template-columns: 1fr;
    }
    .pss-slide__left {
      height: 300px;
    }
    .pss-slide__right {
      padding: 40px 20px;
    }
    .pss-slide__see-more {
      top: 15px;
      right: 20px;
    }
    .pss-slide__product-image {
      max-width: 220px;
    }
    .pss-progress__track {
      height: 1px;
    }
  }
</style>

{% schema %}
{
  "name": "Product Showcase Swiper",
  "tag": "section",
  "settings": [
    {
      "type": "color",
      "id": "bg_color",
      "label": "背景颜色",
      "default": "#F5F5EF"
    },
    {
      "type": "checkbox",
      "id": "autoplay",
      "label": "自动播放",
      "default": true
    },
    {
      "type": "range",
      "id": "autoplay_delay",
      "label": "播放间隔",
      "min": 2000,
      "max": 9000,
      "step": 500,
      "unit": "ms",
      "default": 4000
    },
    {
      "type": "range",
      "id": "speed",
      "label": "切换速度",
      "min": 300,
      "max": 1000,
      "step": 100,
      "unit": "ms",
      "default": 500
    },
    {
      "type": "checkbox",
      "id": "loop",
      "label": "循环播放",
      "default": true
    }
  ],
  "blocks": [
    {
      "type": "slide",
      "name": "幻灯片",
      "settings": [
        {
          "type": "header",
          "content": "左侧图片"
        },
        {
          "type": "image_picker",
          "id": "left_image",
          "label": "图片"
        },
        {
          "type": "header",
          "content": "右侧内容"
        },
        {
          "type": "image_picker",
          "id": "right_image",
          "label": "产品图片（可选，留空则使用产品主图）"
        },
        {
          "type": "product",
          "id": "product",
          "label": "关联产品（动态显示名称和价格）"
        },
        {
          "type": "text",
          "id": "custom_title",
          "label": "自定义标题（无产品时使用）"
        },
        {
          "type": "text",
          "id": "custom_price",
          "label": "自定义价格（无产品时使用）"
        },
        {
          "type": "header",
          "content": "See More 链接"
        },
        {
          "type": "text",
          "id": "see_more_text",
          "label": "文字",
          "default": "See More"
        },
        {
          "type": "url",
          "id": "see_more_link",
          "label": "链接"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Product Showcase Swiper",
      "blocks": [{ "type": "slide" }, { "type": "slide" }]
    }
  ]
}
{% endschema %}
