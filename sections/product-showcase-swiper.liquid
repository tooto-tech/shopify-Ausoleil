{%- comment -%}
  Product Showcase Swiper
  使用 _pss-slide block 支持嵌套 blocks
{%- endcomment -%}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css">

<div
  class="pss-section pss-section--{{ section.settings.section_width }}{% if section.settings.custom_class != blank %} {{ section.settings.custom_class }}{% endif %}"
  style="background-color: {{ section.settings.bg_color }}; --pss-min-height: {{ section.settings.min_height }}px; --pss-min-height-mobile: {{ section.settings.min_height_mobile }}px; --pss-mobile-left-height: {{ section.settings.mobile_left_height }}px;"
>
  <div class="swiper pss-swiper" id="pss-{{ section.id }}">
    <div class="swiper-wrapper">
      {% content_for 'blocks' %}
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js" defer></script>

<script>
  (function() {
    function init() {
      if (typeof Swiper === 'undefined') {
        setTimeout(init, 100);
        return;
      }

      var el = document.getElementById('pss-{{ section.id }}');
      if (!el) return;

      var slides = el.querySelectorAll('.swiper-slide.pss-slide');
      var count = slides.length;
      if (count === 0) return;

      var autoplayConfig = false;
      {% if section.settings.autoplay %}
      autoplayConfig = { delay: {{ section.settings.autoplay_delay | default: 4000 }}, disableOnInteraction: false };
      {% endif %}

      var swiper = new Swiper(el, {
        slidesPerView: 1,
        spaceBetween: 0,
        loop: count >= 2 && {{ section.settings.loop | default: true }},
        speed: {{ section.settings.speed | default: 500 }},
        autoplay: autoplayConfig,
        observer: true,
        observeParents: true
      });

      var segD = 70, segM = 35;
      var getSeg = function() { return window.innerWidth <= 749 ? segM : segD; };

      var realSlides = el.querySelectorAll('.swiper-slide.pss-slide:not(.swiper-slide-duplicate)');
      var realCount = realSlides.length;

      var tracks = [], fills = [];
      realSlides.forEach(function(s) {
        var t = s.querySelector('.pss-slide__progress-track');
        var f = s.querySelector('.pss-slide__progress-fill');
        if (t && f) { tracks.push(t); fills.push(f); }
      });

      function layout() {
        var w = getSeg(), total = realCount * w;
        tracks.forEach(function(t) { t.style.width = total + 'px'; });
        fills.forEach(function(f) { f.style.width = w + 'px'; });
      }

      function update() {
        var w = getSeg();
        var idx = swiper.realIndex !== undefined ? swiper.realIndex : 0;
        fills.forEach(function(f) { f.style.transform = 'translateX(' + (idx * w) + 'px)'; });
      }

      tracks.forEach(function(t) {
        t.addEventListener('click', function(e) {
          var rect = t.getBoundingClientRect();
          var target = Math.floor((e.clientX - rect.left) / getSeg());
          if (target >= 0 && target < realCount) {
            swiper.slideToLoop ? swiper.slideToLoop(target) : swiper.slideTo(target);
          }
        });
      });

      layout();
      update();
      swiper.on('slideChange', update);
      window.addEventListener('resize', function() { layout(); update(); });
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      setTimeout(init, 100);
    }
  })();
</script>

<style>
  .pss-section {
    width: 100%;
    display: grid;
  }
  .pss-section--page {
    grid-template-columns:
      minmax(var(--page-margin), 1fr)
      min(var(--page-width) - var(--page-margin) * 2, calc(100% - var(--page-margin) * 2))
      minmax(var(--page-margin), 1fr);
  }
  .pss-section--page > .pss-swiper {
    grid-column: 2;
  }
  .pss-section--full {
    grid-template-columns: 1fr;
  }
  .pss-swiper {
    width: 100%;
    position: relative;
    overflow: hidden;
  }
  .pss-swiper .swiper-wrapper {
    display: flex;
  }
  .pss-swiper .swiper-slide {
    flex-shrink: 0;
    width: 100%;
  }
</style>

<style>
    .pss-slide__container {
      display: grid;
      grid-template-columns: {{ section.settings.left_width }}% 1fr;
    }

    .pss-slide__left { position: relative; width: 100%; height: 100%; overflow: hidden; }
    .pss-slide__left-img { width: 100%; height: 100%; object-fit: cover; display: block; }
    .pss-slide__left-img--mobile { display: none; }
    .pss-slide__placeholder { width: 100%; height: 100%; min-height: 400px; background: rgba(0,0,0,0.05); display: flex; align-items: center; justify-content: center; }
    .pss-slide__placeholder svg { width: 100px; opacity: 0.3; }
    .pss-slide__left-center { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 5; display: flex; flex-direction: column; align-items: center; text-align: center; }
    .pss-slide__left-icon { width: var(--icon-width, 120px); height: auto; display: block; }
    .pss-slide__left-text { margin: 0; text-align: center; font-family: var(--text-font); font-size: var(--text-size); font-weight: var(--text-weight); color: var(--text-color); letter-spacing: var(--text-letter-spacing); margin-top: var(--text-margin-top); }
    .pss-slide__right { position: relative; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 64px 62px 56px 62px; overflow: hidden; min-height: var(--pss-min-height, 600px); }
    .pss-slide__right-bg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 0; }
    .pss-slide__see-more {
    position: absolute;
    bottom: 30px;
    left: 50%;
    transform: translateX(-50%);
    font-family: Mont;
    font-size: 16px;
    font-weight: 900;
    color: #FFFFFF;
    text-decoration: underline;
    z-index: 10;
  }
    .pss-slide__see-more:hover { opacity: 0.7; }
    .pss-slide__right-content { flex: 1; display: flex; flex-direction: column; width: 100%; position: relative; z-index: 1; }
    .pss-slide__progress { width: 100%; display: flex; justify-content: center; padding: 24px 0;  }
    .pss-slide__progress-track { height: 2px; background: rgba(0,0,0,0.2); position: relative; cursor: pointer; }
    .pss-slide__progress-fill { position: absolute; left: 0; top: 0; height: 100%; background: #000; transition: transform 0.3s ease; }


    @media (max-width: 749px) {
      .pss-slide__container { grid-template-columns: 1fr; min-height: auto; }
      .pss-slide__left { height: var(--pss-mobile-left-height, 300px); }
      .pss-slide__left-img--desktop { display: none; }
      .pss-slide__left-img--mobile { display: block; }
      .pss-slide__left-icon { width: var(--icon-width-mobile, 80px); }
      .pss-slide__left-text { font-size: var(--text-size-mobile); font-weight: var(--text-weight-mobile, var(--text-weight)); margin-top: var(--text-margin-top-mobile); }
      .pss-slide__right { padding-top: 40px;padding-bottom: 28px;padding-left:32px;padding-right:46px; min-height: var(--pss-min-height-mobile, 350px); }
        .pss-slide__see-more {
      bottom: 15px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 13px;
      font-weight: 900;
      text-decoration: underline;
    }
      .pss-slide__progress-track { height: 1px; }
    }
</style>

{% schema %}
{
  "name": "Product Showcase Swiper",
  "tag": "section",
  "blocks": [
    {
      "type": "_pss-slide"
    }
  ],
  "settings": [
    {
      "type": "text",
      "id": "custom_class",
      "label": "自定义类名",
      "info": "添加自定义 CSS 类名，多个类名用空格分隔"
    },
    {
      "type": "header",
      "content": "布局设置"
    },
    {
      "type": "select",
      "id": "section_width",
      "label": "宽度",
      "options": [
        {
          "value": "page",
          "label": "页面宽度"
        },
        {
          "value": "full",
          "label": "全宽"
        }
      ],
      "default": "full"
    },
    {
      "type": "color",
      "id": "bg_color",
      "label": "背景颜色",
      "default": "#F5F5EF"
    },
    {
      "type": "range",
      "id": "left_width",
      "label": "左侧宽度",
      "min": 30,
      "max": 70,
      "step": 5,
      "unit": "%",
      "default": 45
    },
    {
      "type": "range",
      "id": "min_height",
      "label": "最小高度（桌面端）",
      "min": 400,
      "max": 900,
      "step": 50,
      "unit": "px",
      "default": 600
    },
    {
      "type": "range",
      "id": "mobile_left_height",
      "label": "左侧图片高度（移动端）",
      "min": 200,
      "max": 500,
      "step": 25,
      "unit": "px",
      "default": 300
    },
    {
      "type": "range",
      "id": "min_height_mobile",
      "label": "右侧最小高度（移动端）",
      "min": 200,
      "max": 600,
      "step": 25,
      "unit": "px",
      "default": 350
    },
    {
      "type": "header",
      "content": "轮播设置"
    },
    {
      "type": "checkbox",
      "id": "autoplay",
      "label": "自动播放",
      "default": true
    },
    {
      "type": "range",
      "id": "autoplay_delay",
      "label": "播放间隔",
      "min": 2000,
      "max": 9000,
      "step": 500,
      "unit": "ms",
      "default": 4000,
      "visible_if": "{{ section.settings.autoplay }}"
    },
    {
      "type": "range",
      "id": "speed",
      "label": "切换速度",
      "min": 300,
      "max": 1000,
      "step": 100,
      "unit": "ms",
      "default": 500
    },
    {
      "type": "checkbox",
      "id": "loop",
      "label": "循环播放",
      "default": true
    }
  ],
  "presets": [
    {
      "name": "Product Showcase Swiper"
    }
  ]
}
{% endschema %}
